#include<stdio.h>
#include<conio.h>   //使用getch()函数 
#include<time.h> 
#include <stdlib.h>
int num[4][4];
//定义一个数组num，用于存储游戏中的数字
int score, gameover, ifappear, gamew, gamef, move;
//定义一个变量，用于存储玩家得分
char key;
//定义一个变量，用于存储玩家输入的按键
void explation()
{
    void menu();
    system("cls");
    printf("\t\t*****************************************\t\t\n");
    printf("\t\t*****************************************\n");
    printf("\t\t******************游戏规则***************\n");
    printf("\t\t*****************************************\n");
    printf("\t\t*****************************************\t\t\n");
    printf("玩家可以选择上、下、左、右或W、A、S、D去移动滑块\n");
    printf("玩家选择的方向上若有相同的数字则合并\n");
    printf("合并所得的所有新生成数字相加即为该步的有效得分\n");
    printf("玩家选择的方向行或列前方有空格则出现位移\n");
    printf("每移动一步，空位随机出现一个2或4\n");
    printf("棋盘被数字填满，无法进行有效移动，判负，游戏结束\n");
    printf("棋盘上出现2048，获胜，游戏结束\n");
    printf("按上下左右去移动滑块\n");
    printf("请按任意键返回主菜单...\n");
    _getch();
    system("cls");
}
void gamefaile()
{
    int i, j;
    system("cls");
    printf("\t\t*****************************************\t\t\n");
    printf("\t\t*****************************************\n");
    printf("\t\t******************you fail***************\n");
    printf("\t\t*****************************************\n");
    printf("\t\t*****************************************\t\t\n");
    printf("\t\t\t---------------------\n\t\t\t");
    for (j = 0; j < 4; j++)
    {
        for (i = 0; i < 4; i++)
            if (num[j][i] == 0)
                printf("|    ");
            else
                printf("|%4d", num[j][i]);
        printf("|\n");
        printf("\t\t\t---------------------\n\t\t\t");
    }
    printf("你的成绩：%d,移动了%d步\n", score, move);
    printf("请按任意键返回主菜单...\n");
    _getch();
    system("cls");

}
void gamewin()
{
    //定义变量i,j
    int i, j;
    //清屏
    system("cls");
    //打印标题
    printf("\t\t*****************************************\t\t\n");
    printf("\t\t*****************************************\n");
    printf("\t\t*******************you win***************\n");
    printf("\t\t*****************************************\n");
    printf("\t\t*****************************************\t\t\n");
    //打印分割线
    printf("\t\t\t---------------------\n\t\t\t");
    //打印表格
    for (j = 0; j < 4; j++)
    {
        for (i = 0; i < 4; i++)
            if (num[j][i] == 0)
                printf("|    ");
            else
                printf("|%4d", num[j][i]);
        printf("|\n");
        printf("\t\t\t---------------------\n\t\t\t");
    }
    //打印分数和移动步数
    printf("你的成绩：%d,移动了%d步\n", score, move);
    //打印提示信息
    printf("请按任意键返回主菜单...\n");
    //等待按键
    _getch();
    //清屏
    system("cls");
}
void prin()
{
    int i, j;
    system("cls");
    printf("\t\t*****************************************\t\t\n");//输出界面
    printf("\t\t*****************************************\n");
    printf("\t\t******************游戏开始***************\n");
    printf("\t\t*****************************************\n");
    printf("\t\t*****************************************\t\t\n");
    printf("\t\t      请按方向键或W、A、S、D移动滑块\n");//输出操作提示语句
    printf("\t\t          按ESC返回至主菜单\n");
    printf("\t\t\t---------------------\n\t\t\t");
    for (j = 0; j < 4; j++)                 //输出4*4的表格
    {
        for (i = 0; i < 4; i++)
            if (num[j][i] == 0)
                printf("|    ");
            else
                printf("|%4d", num[j][i]);
        printf("|\n");
        printf("\t\t\t---------------------\n\t\t\t");
    }
    printf("你的成绩：%d，移动了%d步\n", score, move);//输出得分和移动步数
}
void appear()
{
    int i, j, ran, t[16], x = 0, a, b;
    srand((int)time(0));          //随机种子初始化
    for (j = 0; j < 4; j++)      //将空白的区域的坐标保存到中间数组t中
        for (i = 0; i < 4; i++)
            if (num[j][i] == 0)
            {
                t[x] = j * 10 + i;
                x++;
            }
    if (x == 1)            //在t中随机取一个坐标
        ran = x - 1;
    else
        ran = rand() % (x - 1);
    a = t[ran] / 10;      //取出这个数值的十位数
    b = t[ran] % 10;     //取出这个数值的个位数
    srand((int)time(0));
    if ((rand() % 9) > 2)    //在此空白区域随机赋值2或4
        num[a][b] = 2;
    else
        num[a][b] = 4;
}
void close()
{
    // 关闭游戏
    exit(0);
}
void add(int* p)
{

    int i = 0, b;
    while (i < 3)
    {
        //如果当前元素不为0
        if (*(p + i) != 0)
        {
            //从当前元素的下一个元素开始，查找是否有与当前元素相等的元素
            for (b = i + 1; b < 4; b++)
            {
                //如果找到相等的元素
                if (*(p + b) != 0)
                    //如果当前元素和相等元素相等
                    if (*(p + i) == *(p + b))
                    {
                        //将两个元素相加
                        score = score + (*(p + i)) + (*(p + b));
                        //将当前元素替换为相加后的结果
                        *(p + i) = *(p + i) + *(p + b);
                        //如果当前元素等于2048，则游戏结束
                        if (*(p + i) == 2048)
                            gamew = 1;
                        //将相等元素替换为0
                        *(p + b) = 0;
                        //将i指向相等元素的下一个元素
                        i = b + i;
                        //出现次数加1
                        ++ifappear;
                        //跳出循环
                        break;
                    }
                    else
                    {
                        //如果当前元素和相等元素不相等，则将i指向相等元素
                        i = b;
                        //跳出循环
                        break;
                    }
            }
            //如果遍历完所有的元素，没有找到相等的元素，则i加1
            if (b == 4)
                i++;
        }
        //如果当前元素为0，则i加1
        else
            i++;
    }

}
void Gameplay()
{
    int i, j, g, e, a, b[4];
    // 显示两个随机数
    appear();
    appear();
    // 循环游戏
    while (1)
    {
        // 如果随机数出现，则显示一个随机数
        if (ifappear != 0)
            appear();
        // 显示游戏板
        prin();
        // 获取按键
        key = _getch();
        // 根据按键进行操作
        switch (key)
        {
        case 'w':
        case 'W':
        case 72:
            // 向上移动
            ifappear = 0;
            for (j = 0; j < 4; j++)
            {
                for (i = 0; i < 4; i++)
                {
                    b[i] = num[i][j];
                    num[i][j] = 0;
                }
                add(b);
                e = 0;
                for (g = 0; g < 4; g++)
                {
                    if (b[g] != 0)
                    {
                        num[e][j] = b[g];
                        if (g != e)
                            ++ifappear;
                        e++;
                    }
                }
            }
            if (ifappear != 0)
                ++move;
            break;
        case 's':
        case 'S':
        case 80:
            // 向下移动
            ifappear = 0;
            for (j = 0; j < 4; j++)
            {
                for (i = 0; i < 4; i++)
                {
                    b[i] = num[i][j];
                    num[i][j] = 0;
                }
                add(b);
                e = 3;
                for (g = 3; g >= 0; g--)
                {
                    if (b[g] != 0)
                    {
                        num[e][j] = b[g];
                        num[j][e] = b[g];
                        if (g != e)
                            ++ifappear;
                        e--;
                    }
                }
            }
            if (ifappear != 0)
                ++move;
            break;
        case 'a':
        case 'A':
        case  75:
            // 向左移动
            ifappear = 0;
            for (j = 0; j < 4; j++)
            {
                for (i = 0; i < 4; i++)
                {
                    b[i] = num[j][i];
                    num[j][i] = 0;
                }
                add(b);
                e = 0;
                for (g = 0; g < 4; g++)
                {
                    if (b[g] != 0)
                    {
                        num[j][e] = b[g];
                        if (g != e)
                            ++ifappear;
                        e++;
                    }
                }
            }
            if (ifappear != 0)
                ++move;
            break;
        case 'd':
        case 'D':
        case  77:
            // 向右移动
            ifappear = 0;
            for (j = 0; j < 4; j++)
            {
                for (i = 0; i < 4; i++)
                {
                    b[i] = num[j][i];
                    num[j][i] = 0;
                }
                add(b);
                e = 3;
                for (g = 3; g >= 0; g--)
                {
                    if (b[g] != 0)
                    {
                        num[j][e] = b[g];
                        if (g != e)
                            ++ifappear;
                        e--;
                    }
                }
            }
            if (ifappear != 0)
                ++move;
            break;
        case 27:
            // 退出游戏
            system("cls");
            break;
        }
        for (j = 0; j < 4; j++)
        {
            for (i = 0; i < 4; i++)
            {
                if (j < 3)
                {
                    if (i < 3)
                    {
                        if (num[j][i] == num[j + 1][i] || num[j][i] == num[j][i + 1] || num[j][i] == 0)
                        {
                            gamef = 0;
                            break;
                        }
                        else
                            gamef = 1;
                    }
                    else
                    {
                        if (num[j][i] == num[j + 1][i] || num[j][i] == 0)
                        {
                            gamef = 0;
                            break;
                        }
                        else
                            gamef = 1;
                    }
                }
                else
                {
                    if (i < 3)
                    {
                        if (num[j][i] == num[j][i + 1] || num[j][i] == 0 || num[j][i + 1] == 0)
                        {
                            gamef = 0;
                            break;
                        }
                        else
                            gamef = 1;
                    }
                }

            }
            if (gamef == 0)
                break;
        }
        if (gamef == 1 || gamew == 1)
            break;

    }
    if (gamef == 1)
        gamefaile();
    else
        gamewin();
}
void menu()
{
    int n;
    printf("\t\t*****************************************\t\t\n");            //输出游戏菜单的图形
    printf("\t\t*              1、开始游戏              *\n");
    printf("\t\t*              2、游戏规则              *\n");
    printf("\t\t*              3、退出游戏              *\n");
    printf("\t\t*****************************************\n");
    printf("请输入1或2或3:[ ]\b\b");
    scanf_s("%d", &n);
    switch (n)
    {
    case 1:
        Gameplay();                                                         //游戏开始函数
        break;
    case 2:
        explation();                                                       //游戏规则函数
        break;
    case 3:
        close();                                                          //关闭游戏函数
        break;
    }
}
int main()
{
    int j, i;
    for (j = 0; j < 4; j++)             //对4*4进行初始赋值为0
        for (i = 0; i < 4; i++)
            num[j][i] = 0;
    gamew = 0;                        //游戏获胜的判断变量初始化
    gamef = 0;                       //游戏失败的判断变量初始化
    ifappear = 0;                   //判断是否应该随机出现2或4的变量初始化
    score = 0;                     //游戏得分变量初始化
    gameover = 0;                 //游戏是否结束的变量初始化
    move = 0;                    //游戏的移动步数初始化
    menu();                     //调用主菜单函数
    return 0;
}
